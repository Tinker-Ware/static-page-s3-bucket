---
- name: Clone repo for static files and upload it to AWS S3.
  hosts: localhost
  connection: local
  tasks:
    - name: Include vars
      include_vars: encrypted_vars.yml

    - name: Clone static files repo
      git:
        repo: "git@github.com:Tinker-Ware/homepage.git"
        version: development
        dest: homepage
        force: yes
        accept_hostkey: yes
        key_file: "$HOME/.ssh/id_rsa.pub"
    
    - name: Install node dependencies
      command: "npm install" 
      args:
        chdir: homepage

    - name: Build static page
      command: "gulp dist"
      args:
        chdir: homepage

    - name: Move dist folder
      command: "mv dist ../static-files"
      args:
        chdir: homepage

    - name: Add placeholder error.html for S3 bucket
      shell: "echo 'Error loading page' > error.html"
      args:
        chdir: static-files

    - name: Upload static files to S3 bucket
      s3_sync:
        region: "us-east-1"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        bucket: "{{ bucket_name }}"
        file_root: "static-files/"
        include: "*"
  
    - name: Remove cloned repo folder
      file:
        state: absent
        path: homepage/

    - name: Remove static-files folder
      file:
        state: absent
        path: static-files/
